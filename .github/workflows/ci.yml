# .github/workflows/ci.yml

name: 'release: Build & Release'

on:
    push:
        # ğŸŒŸ è§¦å‘äº‹ä»¶ï¼šå½“ä¸€ä¸ªæ–°çš„ Git Tag è¢«æ¨é€åˆ° GitHub æ—¶
        tags:
            - 'v*'

env:
    # ç¯å¢ƒå˜é‡ï¼šç¡®ä¿ Rust å’Œ Node.js çš„ç‰ˆæœ¬ä¸€è‡´æ€§
    RUST_TOOLCHAIN: stable
    NODE_VERSION: '20'

jobs:
    build-tauri:
        # ä»»åŠ¡åç§°å’Œè¿è¡Œå¹³å°
        name: ${{ matrix.platform.os }} (${{ matrix.platform.target }})
        runs-on: ${{ matrix.platform.os }}

        permissions:
            contents: write # æˆäºˆå†™å…¥æƒé™ï¼Œå…è®¸ä¸Šä¼  Release Assets

        strategy:
            fail-fast: false
            matrix:
                # ğŸŒŸ å®šä¹‰è¦æ‰“åŒ…çš„ç›®æ ‡å¹³å°
                platform:
                    # - os: ubuntu-latest
                    #   target: ${{ (github.event.inputs.skip_linux == 'true' && '') || 'x86_64-unknown-linux-gnu' }}
                    # macOS å’Œ Windows æ¨èä½¿ç”¨é»˜è®¤çš„ targetï¼ŒTauri ä¼šè‡ªåŠ¨å¤„ç†
                    - os: macos-latest
                    - os: windows-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: true
                  lfs: true

            - name: Install pnpm
              run: npm install -g pnpm

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  # ğŸŒŸ è¿™é‡Œè®¾ç½®äº† cache: 'pnpm'ï¼Œä½†æ²¡æœ‰å®‰è£… pnpm æœ¬èº«
                  cache: 'pnpm'

            - name: Install Rust
              uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: ${{ env.RUST_TOOLCHAIN }}
                  targets: ${{ matrix.platform.target }}

            # 2. å®‰è£…ç³»ç»Ÿä¾èµ– (Linux éœ€è¦)
            - name: Install Dependencies (Linux)
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev libvips

            # 3. å®‰è£…å‰ç«¯ä¾èµ–
            - name: Install Frontend Dependencies
              run: pnpm install --frozen-lockfile

            # 4. æ„å»ºå‰ç«¯ (æ‰§è¡Œ pnpm build)
            - name: Build Frontend
              run: pnpm build

            # 5. æ‰“åŒ… Tauri åº”ç”¨
            - name: Build Tauri App
              # ğŸŒŸ å…³é”®ä¿®æ­£ 1: ç¡®ä¿ä½¿ç”¨ v0
              uses: tauri-apps/tauri-action@v0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tagName: ${{ github.ref_name }}

                  releaseName: 'App Release ${{ github.ref_name }}'
                  releaseBody: 'See the assets to download this version.'

                  includeDebug: false

                  args: ${{ matrix.platform.target && format('--target {0}', matrix.platform.target) || '' }}
